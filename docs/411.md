# 记录异常:在哪里记录异常？

> 原文:[https://jen kov . com/tutorials/Java-exception-handling/logging-where-to-log-exceptions . html](https://jenkov.com/tutorials/java-exception-handling/logging-where-to-log-exceptions.html)

通常要求必须记录业务应用程序中出现的异常，以便在必要时可以由人工进行进一步检查。尤其是在 web 或服务器应用程序中，控制台输出可能无法用于检查。异常日志通过包含足够的信息来揭示错误的原因，或者帮助再现异常，从而有助于确定哪里出错了。

在设计应用程序的日志记录时，经常会出现这样的问题:应该在代码的什么地方记录异常？基本上你有三种不同的选择:

1.  底层日志
    记录发生异常的组件

2.  中级日志记录
    在调用栈中间的某个地方进行日志记录，这里有足够的信息可用(组件调用的上下文)

3.  顶层日志记录
    在调用栈顶部集中日志记录

下面的清单显示了一个调用栈，其中组件 A 调用 B。B 调用其他组件，这些组件又调用组件 f。组件 A 是顶级组件，B 等等。是中级组件，而 F 是底层组件。

```
    A
      B
        ...
          F

```

## 底层测井

第一种选择是在发生异常的组件中记录异常。如果您不能改变该组件的源代码，那么您将尽可能地记录抛出异常的组件方法调用。乍一看，将日志封装在抛出异常的组件中似乎是一个不错的设计选择。然而，这种方法有一些缺点。

首先，必须将日志记录编码到每个能够抛出异常的组件中，或者调用抛出异常的第三方组件。这需要编写和维护大量的日志代码。

其次，如果组件要在不同的应用程序中重用，那么组件无法知道如何在每个应用程序中记录异常。您必须让日志策略可以插入到组件中，这样日志就不会被真正封装。

第三，抛出异常的组件可能真的没有足够的信息来编写详细而合理的日志消息。假设您有一个将对象写入数据库的组件。因为其中一个字段为空，所以引发了异常。该组件能准确地说出日志中哪个字段为空吗？它能解释为什么这个字段是空的吗？也许对象加载时该字段为空，或者用户采取的某些操作导致它变为空。或者可能是某些代码中的错误导致该字段变为空。组件知道异常发生时是哪个用户登录的吗？日志记录可能需要所有这些信息。底层组件可能没有所有可用信息。所需信息的其余部分可以在调用堆栈的更高层获得。如果日志记录是在组件内部底层完成的，则不能记录该信息。

## 中级测井

作为底层日志记录的替代方法，只要有足够的信息来编写令人满意的日志消息，您就可以在中间级别进行日志记录。这使得底层组件没有日志记录代码，但是它也有一些缺点。

在中间层，您可能没有抛出异常的底层组件的所有详细信息。底层组件必须提供一个详细的错误文本，可能还有错误代码，以便在中间层进行合理的日志记录。

在中级日志记录时，仍然有许多日志记录代码要写。在每个捕获和记录异常的地方，都必须插入几乎相同的日志记录代码。如果您稍后需要更改日志记录策略，这将需要做大量的工作。一个捷径是使用面向方面的编程来注入日志代码，但是我不会在这里深入讨论。

## 顶级日志记录

顶级日志记录意味着您在代码中有一个单一的中心位置，可以捕获所有抛出的异常并记录它们。在 Java web 应用程序中，它可能是一个控制 servlet，也可能是一个 servlet 过滤器。在桌面应用程序中，也许您的事件处理程序会扩展一个基本事件处理程序，能够捕获和记录所有抛出的异常。

顶级日志记录的优点是在应用程序中只有一个地方可以编写和维护日志记录代码。除了更容易实现之外，如果需要的话，这也使得将日志实现推迟到开发过程的后期更容易。日志记录代码只需要在一个地方实现，很可能不会改变整个应用程序调用结构。

顶层日志记录的缺点当然是，这个单一的中心位置不知道底层组件中抛出异常的地方出了什么问题，也不知道调用该组件的中间层代码试图做什么。这使得编写合理的日志消息有些困难。

## 异常丰富

为了克服顶层(在某种程度上也包括中层)缺乏细节的问题，您可以丰富异常，因为它们会沿着调用栈向上传播到顶层。丰富异常是通过捕获它们、添加额外的信息并再次抛出它们来完成的。重新抛出捕获的 Java 异常不会改变嵌入的堆栈跟踪。堆栈跟踪保持与底层组件第一次抛出异常时相同。

为了使异常丰富成为可能，您必须编写自己的异常类。或者，您必须将捕获的异常包装在新的异常中，并抛出新的异常。

## 总结和建议

我们已经研究了三种不同的日志策略:底层、中层和顶层日志。

我建议尽可能使用顶级日志，因为它最容易编码和维护，如果您不想一开始就被它困扰，也可以在开发过程的后期添加。您可能会遇到必须在较低级别捕获和处理异常的情况，但根据我的经验，这种情况并不经常发生。最常见的情况是，当异常发生时，请求或事件处理会被跳过，并且异常会记录足够的信息来确定错误的原因，或者至少重现错误。