# 多态虚拟机简介

> 原文：<https://jenkov.com/tutorials/polymorph-vm/index.html>

*polymort VM*是一个虚拟机，设计用于嵌入 Java 应用程序，使您的应用程序 或服务在某种程度上可以从外部脚本化。这将您的应用程序或服务变成了一个“平台”—— ，从而使外界能够以编程的方式与您的应用程序进行交互。 与你的应用程序的程序化交互使交互比手动交互、固定的消息格式、配置文件等更通用、更灵活 和更智能。

## 100%沙盒化——除了您插入的函数

多态虚拟机是 100%沙箱化的——除了*插件函数*,你决定在让 虚拟机执行脚本之前插入它。如果你不插入任何功能，脚本就不能到达虚拟机之外的任何地方。没有对本地文件系统、网络、操作系统或 Java 类层次结构的内置访问。

100%沙盒确保您在应用程序内部执行脚本时，获得对安全性的最大控制。

### 插件功能

在完全不能访问应用程序内部任何资源的情况下执行一个脚本是没有用的。通常，您会希望脚本能够访问您的应用程序或服务中的某些功能。

为了使应用程序内部的功能对脚本可用，你可以插入一个或多个脚本可以调用的函数(用 Java 实现)。

## 用例

Polymorph VM 主要是为允许从外部对应用程序或服务进行某种程度的脚本编写而设计的。当我设计多态虚拟机时，我想到的主要用例是:

*   对桌面应用程序或服务使用脚本而不是配置文件。
*   使用脚本作为宏语言。
*   使客户端能够向服务发送脚本，而不是让服务支持固定的“消息”或“功能”。

在接下来的章节中，我将详细阐述这些用例。

### 脚本而不是配置文件

想象一下，能够通过脚本而不是通过声明性配置文件格式(如 YAML、JSON、属性文件等)来配置桌面应用程序或服务。).脚本可以在配置过程中实现更灵活的决策——允许循环、条件配置、函数调用等。所有这些都可以通过传统的配置文件格式来支持，但是通过脚本语言更容易支持。

### 脚本作为宏语言

一些桌面应用程序具有宏语言，可以用来扩展它们的功能，通常是通过将应用程序内部的一组动作组合成命令，这些命令可以根据需要重复。通过插入一个多态虚拟机，你可以免费获得一个宏语言，并通过插件功能将你想展示的功能插入到宏语言中。

### 脚本代替消息

想象一下，能够向服务发送一个脚本来执行，而不是一个固定的消息。脚本可以访问您的服务公开的一组函数——使脚本能够智能地决定调用什么函数——而不必在每次决定之间返回客户端。

## 非设计目标

Polymorph VM 不是一个通用的编程平台。目标只是在现有的应用程序中运行较小的脚本。因此，该语言相当简单，并且没有针对性能进行优化。繁重的计算或特殊的应用程序或平台功能预计将通过调用插件函数来执行。

## 设计目标

多形态虚拟机的设计考虑了以下设计目标:

*   小型脚本语言
*   高表现力
*   流式执行
*   单线程并发的增量执行

我将在下面几节中详细阐述这些设计目标:

### 小语言

因为 Polymorph VM 的目标不是创建一个通用的应用程序平台——所以没有理由实现一个高度高级的脚本语言。事实上，恰恰相反。语言越小，越容易学。当然，这种语言可以有多小也是有限度的，但是我正努力保持它的小。

### 高表现力

因为多态虚拟机的脚本语言的目标用例是通过网络发送到服务的配置或查询，所以语言的高度表达性是有益的。我所说的高度表达性是指一种能够用简洁的语法表达大量意思的语言。

我有两个语法建议，将方法链(流体风格的 API)直接构建到语言本身中。这些语法建议将使表达更复杂的对象图比使用普通 Java 更容易。对象图通常用于配置 API 或应用程序，以及表达复杂的命令或查询。因此，对象图的简明表达对于这种语言的目标用例是有用的。

### 流式执行

Polymorph VM 的脚本语言是为流执行而设计的——这意味着必须能够在加载/下载/接收完整的脚本之前开始执行脚本。这也意味着 VM 不能依赖本地文件系统中可用的脚本所使用的所有函数或类型，其他语言就是这种情况。对于能够使用函数或类型的脚本，它必须事先在流中定义。

当使用脚本语言在客户机和服务器之间传送对话时，流执行是有用的。

### 增量执行

脚本语言(至少是它的 bincode)是为增量执行而设计的。这意味着指令必须一次一个指令增量地可执行。对于原子指令，这并不难实现，但是对于可以有嵌套指令的指令，比如 if 语句、循环和函数调用，这就比较困难了。然而，我相信我已经为支持这一点的 bincode 和 VM 找到了一个可行的设计。

增量执行使多个虚拟机在一个线程中并发执行脚本成为可能。线程可以在以循环方式在每个虚拟机内执行增量之间切换——就好像每个虚拟机都由自己的线程执行一样。因此，增量执行支持单线程并发(在同一线程内同时执行多个任务)。

单线程并发在使用单线程/同线程设计的服务器和路由器内部是有用的——这是多态结构节点打算使用的。

[单线程并发](/tutorials/java-concurrency/single-threaded-concurrency.html)T2