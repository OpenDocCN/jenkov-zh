# RSync -检测文件差异

> 原文:[https://jen kov . com/tutorials/rsync/detecting-file-differences . html](https://jenkov.com/tutorials/rsync/detecting-file-differences.html)

这篇文章详细介绍了 RSync 如何准确地检测到文件版本之间的差异。

正如我在[概述](overview.html)中提到的，旧版本的文件被分割成 1024 或 2048 字节的块，并为每个块计算校验和。

然后，在新文件中逐字节搜索校验和与旧版本中的校验和相匹配的块。下图说明了这一过程:

<center>

| ![RSync: Block checkums for old file received, and rolling checksum match in new file now begins.](../Images/156045c5a1eb35b1f16f8237bef81b7e.png) |
| 接收到旧文件的块校验和，新文件中的滚动校验和匹配现在开始。 |

</center>

如果您设想块大小为 1024 字节，那么它是这样实现的:

1.  计算块的校验和，文件的字节 0 到 1023。
2.  在旧文件中找到这个校验和了吗？
    如果**没有**，将新文件中的文件指针移动到 1。

    如果**是**，将文件指针在新文件中移动到 1024。
    在旧文件中存储什么块的信息，这个块在新文件中匹配。

3.  在新文件位置返回到 1，直到块校验和与旧文件中的块校验和匹配，或者到达文件结尾。

对文件的新版本重复这些操作，您将逐字节遍历文件。在这个迭代过程中，您会发现文件中有两种类型的数据:

1.  与旧文件中的块相匹配的数据块。
2.  不属于匹配块的字节序列。

您已经看到了如何检测匹配块。但是，我们还需要检测文件差异，而不仅仅是匹配。文件差异包括在匹配块之间留下的**不匹配的数据序列。**

例如，如果您必须在找到匹配块之前搜索到文件中的第 23 个字节，那么前 22 个字节被视为差异。

同样，如果你刚刚找到一个匹配块，跳到它的末尾去搜索下一个匹配块，在找到下一个匹配块之前要迭代 16 个字节，这 16 个字节也算一个文件差。

这里有一个图表，显示了一个以块为单位划分的旧文件，以及一个为匹配块和不匹配序列(差异)而迭代的新版本文件。图上的数字代表块和序列的字节索引。

<center>

| ![Detecing differences between files using block checksums.](../Images/a875476999b84e5d2a63980dba7add8e.png) |
| 使用块校验和来检测文件之间的差异。 |

</center>

为了使保存旧版本文件的计算机能够创建与新版本相同的新副本，该计算机需要旧文件中的块引用列表，以及差异(数据)列表。稍后将详细介绍。